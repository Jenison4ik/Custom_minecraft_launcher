version: "3.9" # –í–µ—Ä—Å–∏—è Docker Compose, 3.9 ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

services:
  app:
    build: .
    container_name: server_app
    restart: always
    env_file:
      - .env # –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
    environment:
      - PORT=${PORT}
      - SECRET_KEY=${SECRET_KEY}
    expose:
      - "${PORT}"
    volumes:
      - ./data:/app/data
      - ./game:/app/game
      - ./launcher:/app/launcher
    networks:
      - webnet

  nginx:
    image: nginx:latest
    container_name: nginx_proxy
    restart: always
    ports:
      - "80:80" # HTTP –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –≤—ã–¥–∞—á–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      - "443:443" # HTTPS
    volumes:
      - ./docker_nginx_temp:/var/cache/nginx/client_temp
      - ./nginx/nginx.conf:/etc/nginx/templates/nginx.conf.template:ro # –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å HTTPS
      - ./nginx/nginx-init.conf.template:/etc/nginx/templates/nginx-init.conf.template:ro # –ù–∞—á–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑ HTTPS
      - ./nginx/entrypoint.sh:/docker-entrypoint.sh:ro # Entrypoint —Å–∫—Ä–∏–ø—Ç
      - ./nginx/certbot/conf:/etc/letsencrypt # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Let's Encrypt
      - ./nginx/certbot/www:/var/www/certbot # –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–º–µ–Ω–∞
      - ./static:/app/server_app/static # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    depends_on:
      - app
    environment:
      - DOMAIN=${DOMAIN}
    entrypoint: ["/bin/sh", "/docker-entrypoint.sh"]
    networks:
      - webnet

  # –°–µ—Ä–≤–∏—Å –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: docker-compose --profile init run --rm certbot-init
  certbot-init:
    image: certbot/certbot
    container_name: certbot_init
    env_file:
      - .env # –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
    volumes:
      - ./nginx/certbot/conf:/etc/letsencrypt
      - ./nginx/certbot/www:/var/www/certbot
    entrypoint: >
      /bin/sh -c "
        if [ -z \"$$DOMAIN\" ]; then
          echo '‚ùå –û—à–∏–±–∫–∞: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è DOMAIN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
          exit 1;
        fi
        EMAIL=\"$${LETSENCRYPT_EMAIL:-admin@$$DOMAIN}\"
        CERT_DIR=\"/etc/letsencrypt\"
        LIVE_DIR=\"$$CERT_DIR/live\"
        ARCHIVE_DIR=\"$$CERT_DIR/archive\"
        RENEWAL_DIR=\"$$CERT_DIR/renewal\"
        
        echo \"üîê –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è $$DOMAIN...\";
        echo \"üìß Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: $$EMAIL\";
        
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–æ–º–µ–Ω–∞
        echo 'üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...';
        rm -rf \"$$LIVE_DIR/$$DOMAIN\"* 2>/dev/null
        rm -rf \"$$ARCHIVE_DIR/$$DOMAIN\"* 2>/dev/null
        rm -f \"$$RENEWAL_DIR/$$DOMAIN\"*.conf 2>/dev/null
        echo '‚úÖ –°—Ç–∞—Ä—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã';
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
        certbot certonly --non-interactive --webroot -w /var/www/certbot --email \"$$EMAIL\" --agree-tos --no-eff-email -d \"$$DOMAIN\" -d \"www.$$DOMAIN\" && {
          # –ò—â–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
          NEW_CERT=\$(ls -d \"$$LIVE_DIR/$$DOMAIN\"* 2>/dev/null | head -1)
          if [ -n \"$$NEW_CERT\" ] && [ -f \"$$NEW_CERT/fullchain.pem\" ]; then
            echo '‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã!';
            echo \"üìÅ –ü—É—Ç—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É: $$NEW_CERT/fullchain.pem\";
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å
            CERT_COUNT=\$(ls -d \"$$LIVE_DIR/$$DOMAIN\"* 2>/dev/null | wc -l)
            if [ \"$$CERT_COUNT\" -gt 1 ]; then
              echo '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π...';
              # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π (—Å–∞–º—ã–π –Ω–æ–≤—ã–π)
              ls -dt \"$$LIVE_DIR/$$DOMAIN\"* 2>/dev/null | tail -n +2 | xargs rm -rf 2>/dev/null
              echo '‚úÖ –õ–∏—à–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã';
            fi
            echo 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ nginx: docker exec nginx_proxy nginx -s reload';
          else
            echo '‚ö†Ô∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–ª—É—á–µ–Ω, –Ω–æ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω';
          fi
        } || {
          echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤';
          exit 1;
        }
      "
    depends_on:
      - nginx
    environment:
      - DOMAIN=${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    networks:
      - webnet
    profiles:
      - init # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º init: docker-compose --profile init run --rm certbot-init

  # –°–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: docker-compose --profile renew up -d certbot
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./nginx/certbot/conf:/etc/letsencrypt
      - ./nginx/certbot/www:/var/www/certbot
    entrypoint: >
      /bin/sh -c "trap exit TERM; while :; do
        certbot renew --webroot -w /var/www/certbot;
        docker exec nginx_proxy nginx -s reload;
        sleep 12h;
      done"
    depends_on:
      - nginx
    networks:
      - webnet
    profiles:
      - renew # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º renew: docker-compose --profile renew up -d certbot

networks:
  webnet:
    driver: bridge
