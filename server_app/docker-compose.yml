version: "3.9" # Ð’ÐµÑ€ÑÐ¸Ñ Docker Compose, 3.9 â€” ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ð²ÑÐµ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

services:
  app:
    build: .
    container_name: server_app
    restart: always
    env_file:
      - .env # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð° .env
    environment:
      - PORT=${PORT}
      - SECRET_KEY=${SECRET_KEY}
    expose:
      - "${PORT}"
    volumes:
      - ./data:/app/data
      - ./game:/app/game
      - ./launcher:/app/launcher
    networks:
      - webnet

  nginx:
    image: nginx:latest
    container_name: nginx_proxy
    restart: always
    ports:
      - "80:80" # HTTP Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð²Ñ‹Ð´Ð°Ñ‡Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
      - "443:443" # HTTPS
    volumes:
      - ./docker_nginx_temp:/var/cache/nginx/client_temp
      - ./nginx/nginx.conf:/etc/nginx/templates/nginx.conf.template:ro # ÐŸÐ¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ñ HTTPS
      - ./nginx/nginx-init.conf.template:/etc/nginx/templates/nginx-init.conf.template:ro # ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð±ÐµÐ· HTTPS
      - ./nginx/entrypoint.sh:/docker-entrypoint.sh:ro # Entrypoint ÑÐºÑ€Ð¸Ð¿Ñ‚
      - ./nginx/certbot/conf:/etc/letsencrypt # Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Let's Encrypt
      - ./nginx/certbot/www:/var/www/certbot # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¿Ð°Ð¿ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð¾Ð¼ÐµÐ½Ð°
      - ./static:/app/server_app/static # Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°
    depends_on:
      - app
    environment:
      - DOMAIN=${DOMAIN}
    entrypoint: ["/bin/sh", "/docker-entrypoint.sh"]
    networks:
      - webnet

  # Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: docker-compose --profile init run --rm certbot-init
  certbot-init:
    image: certbot/certbot
    container_name: certbot_init
    volumes:
      - ./nginx/certbot/conf:/etc/letsencrypt
      - ./nginx/certbot/www:/var/www/certbot
    entrypoint: >
      /bin/sh -c "
        DOMAIN=$${DOMAIN}
        EMAIL=$${CERTBOT_EMAIL:-admin@$${DOMAIN}}
        CERT_PATH=\"/etc/letsencrypt/live/$${DOMAIN}/fullchain.pem\"
        
        if [ ! -f \"$${CERT_PATH}\" ]; then
          echo 'ðŸ” ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð´Ð»Ñ $${DOMAIN}...';
          echo 'ðŸ“§ Email Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹: $${EMAIL}';
          certbot certonly --webroot -w /var/www/certbot \
            --email \"$${EMAIL}\" --agree-tos --no-eff-email \
            -d \"$${DOMAIN}\" -d \"www.$${DOMAIN}\" || {
              echo 'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²';
              exit 1;
            }
          if [ -f \"$${CERT_PATH}\" ]; then
            echo 'âœ… Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹!';
            echo 'ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ nginx: docker exec nginx_proxy nginx -s reload';
          fi
        else
          echo 'âœ… Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚ Ð² $${CERT_PATH}';
        fi
      "
    depends_on:
      - nginx
    environment:
      - DOMAIN=${DOMAIN}
      - CERTBOT_EMAIL=${CERTBOT_EMAIL:-} # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ email, Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ admin@${DOMAIN}
    networks:
      - webnet
    profiles:
      - init # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¼ init: docker-compose --profile init run --rm certbot-init

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./nginx/certbot/conf:/etc/letsencrypt
      - ./nginx/certbot/www:/var/www/certbot
    entrypoint: >
      /bin/sh -c "trap exit TERM; while :; do
        certbot renew --webroot -w /var/www/certbot;
        docker exec nginx_proxy nginx -s reload;
        sleep 12h;
      done"
    depends_on:
      - nginx
    networks:
      - webnet

networks:
  webnet:
    driver: bridge
