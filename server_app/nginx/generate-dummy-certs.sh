#!/bin/sh
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –í–∞—Ä–∏–∞–Ω—Ç–µ 2 —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã SSL

set -e

DOMAIN=${DOMAIN:-localhost}
CERT_DIR="/etc/letsencrypt/live/${DOMAIN}"

if [ ! -f "${CERT_DIR}/fullchain.pem" ]; then
    echo "üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è ${DOMAIN}..."
    mkdir -p "${CERT_DIR}"
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ 1 –¥–µ–Ω—å
    openssl req -x509 -nodes -days 1 -newkey rsa:2048 \
        -keyout "${CERT_DIR}/privkey.pem" \
        -out "${CERT_DIR}/cert.pem" \
        -subj "/CN=${DOMAIN}/O=Self-Signed/C=RU"
    
    # –°–æ–∑–¥–∞–µ–º fullchain.pem (–¥–ª—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ cert.pem)
    cp "${CERT_DIR}/cert.pem" "${CERT_DIR}/fullchain.pem"
    
    echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –≤ ${CERT_DIR}"
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã! –ü–æ–ª—É—á–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ —á–µ—Ä–µ–∑ certbot."
else
    echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ ${CERT_DIR}"
fi

